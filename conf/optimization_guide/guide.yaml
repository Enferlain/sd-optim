# Example Optimization Guide using Custom Blocks

# --- IMPORTANT ---
# This tells the ParameterHandler in bounds.py to use our custom block definition
# for components listed below that are also defined within sdxl-optim_blocks.yaml.
# It MUST match the 'identifier' in the block config file AND be registered by setup_custom_blocks.
custom_block_config_id: "sdxl-optim_blocks"

# --- Component Optimization Strategies ---
# Define how parameters (like 'alpha' from weighted_sum) are applied.
# The 'name' MUST match a component name in the config identified by 'custom_block_config_id'
# (if defined there) OR in the base model config (e.g., 'sdxl-sgm').

components:
  - name: unet
    optimize_params: [magnitude_ratio, direction_ratio] # We're still focused on alpha
    strategies:
      # Strategy 1: Optimize specific BLOCKS (all IN, MID, OUT00-OUT07, LABEL_EMBED, ELSE)
      # We use a 'select' strategy targeting block names from sdxl-optim_blocks.
      - type: all
        optimize_params: [magnitude_ratio, direction_ratio] # Explicitly for alpha
        target_type: block       # Tell it these are block names
        keys:
          - "UNET_IN03"
          - "UNET_IN07"
          - "UNET_MID00"
          - "UNET_OUT01"
          - "UNET_OUT08"
          - "UNET_LABEL_EMBED"
          #- "UNET_ELSE"
        # This effectively includes all desired blocks and excludes UNET_OUT08,
        # UNET_TIME_EMBED, and UNET_OUT_FINAL by not listing them.

  - name: # diffuser
    optimize_params: [alpha]
    strategies:
      - type: group
        optimize_params: [alpha] # Both are needed. Strength and Detail.
        target_type: key
        groups:
          - name: out02
            keys:
              - "model.diffusion_model.out.0.bias"
              - "model.diffusion_model.out.0.weight"
              - "model.diffusion_model.out.2.bias"
              - "model.diffusion_model.out.2.weight"
          - name: time_embed
            keys:
              - "*time_embed*"


  - name: clip_l # Define next component
    optimize_params: [magnitude_ratio, direction_ratio]  # [magnitude_ratio, above_average_ratio] # Default params
    strategies:
      - type: single # Apply single strategy to remaining params for this component

  - name: clip_g # Define next component
    optimize_params: [magnitude_ratio, direction_ratio]  # [magnitude_ratio, above_average_ratio] # Default params
    strategies:
      - type: single # Apply single strategy to remaining params for this component

  # Placeholder for layer adjustments (not currently optimized)
  - name: # layer_adjustments
    strategy: none
    parameters: # These are NOT optimized if strategy is 'none', just kept for reference
      detail1: [-2.18, 3]
      detail2: [-2.18, 4]
      detail3: [0, 4]
      contrast: [2.18, 7.5]
      brightness: [-4, -2]
      col1: [-10, 10]
      col2: [-10, 10]
      col3: [-10, 10]

# --- Custom Bounds ---
# Optional section to override the default bounds (0.0, 1.0) for specific parameters
# generated by the strategies above.
# Parameter names depend on the component name, strategy, key/group names, and the merge method's parameter name.
# See the [[Configuration]] wiki page for detailed naming conventions.
custom_bounds:
#  above_average_ratio: [0.75, 2.5]
  # --- Examples based on merge_method having an 'alpha' parameter ---
#  unet_down_op_early_alpha: 1.0
#  calibration_value: [0.25, 2.0]
#  above_average_ratio: [0.8, 2.0]
  # time_embed_alpha: 1.0
  # out02_alpha: 1.0
  # UNET_IN00_alpha: 0.0
  # UNET_OUT07_alpha: 0.5
  # UNET_OUT08_alpha: 0.0
  # UNET_OUT_FINAL_alpha: 0.0
  # UNET_TIME_EMBED_alpha: 0.0
  # --- General Examples ---
  # Override bounds for *all* parameters named 'constraint' (if generated by the strategies)
  # constraint: [0.01, 0.2]

  # Override bounds for *all* parameters named 'k'
  # k: [0.1, 0.5]

  # Set a fixed value for a parameter (it won't be optimized)
  # some_parameter_name: 0.75

  # Define categorical options
  # some_categorical_parameter: [128, 256, 512]

  # Define binary options
  # some_binary_parameter: [0, 1]


# --- Deprecated/Obsolete Sections ---
# custom_ranges: # Removed - Use custom_bounds with specific key names instead
# merge_keys: # Removed - sd-mecha might handle key filtering differently if needed
#   enabled: False
